<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night and Disruptive Duties - Easyjet Compliance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
        }
        
        .gradient-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }
        
        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(102, 126, 234, 0.6);
        }
        
        .result-enter {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .day-section {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .day-1 { border-left-color: #FF6B6B; }
        .day-2 { border-left-color: #4ECDC4; }
        .day-3 { border-left-color: #FFD166; }
        .day-4 { border-left-color: #6A0572; }
        .day-5 { border-left-color: #1A535C; }
        .day-6 { border-left-color: #FF9F1C; }
        .day-7 { border-left-color: #2EC4B6; }
        
        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        input[type="time"] {
            font-family: 'Poppins', sans-serif;
        }
        
        .message-content {
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .message-content strong {
            color: inherit;
            font-weight: 600;
        }
        
        .option-list {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }
        
        .option-list li {
            margin-bottom: 0.8rem;
            position: relative;
            padding-left: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .option-list li::before {
            content: "→";
            position: absolute;
            left: -1.5rem;
            color: #92400e;
            font-weight: bold;
        }
        
        .header-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }
        
        .main-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .verify-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 1.5rem 0;
        }
        
        .result-card {
            border-radius: 0.75rem;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .result-icon {
            font-size: 2rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .violation-point {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .warning-point {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .risk-point {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .risk-highlight {
            border-left: 4px solid #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1) !important;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        /* Enhanced Responsive styles */
        @media (max-width: 768px) {
            .header-bg {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            h1 {
                font-size: 1.5rem !important;
                line-height: 1.2 !important;
            }
            
            p {
                font-size: 0.875rem !important;
                line-height: 1.4 !important;
            }
            
            .day-section {
                flex-direction: column;
                align-items: flex-start !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                border-radius: 0.75rem !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
            }
            
            .day-header {
                width: 100% !important;
                margin-bottom: 0.75rem !important;
                font-size: 1.1rem !important;
                text-align: center !important;
                padding-bottom: 0.5rem !important;
                border-bottom: 2px dashed #e5e7eb !important;
            }
            
            .flex-1 {
                width: 100% !important;
                min-width: 100% !important;
                margin-bottom: 1rem !important;
            }
            
            .flex.items-center {
                width: 100% !important;
                margin-bottom: 1rem !important;
                justify-content: center !important;
                padding: 0.75rem !important;
                background-color: #f9fafb !important;
                border-radius: 0.5rem !important;
            }
            
            .gradient-button {
                padding: 1rem 2rem !important;
                font-size: 1.1rem !important;
                width: 100% !important;
                max-width: 280px !important;
            }
            
            .main-container {
                padding: 1rem !important;
                margin: 0 0.5rem !important;
            }
            
            .verify-section {
                padding: 1.5rem !important;
                margin: 1.5rem 0 !important;
            }
            
            /* Fixed result card padding for mobile */
            .result-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .result-icon {
                font-size: 1.5rem;
                margin-right: 0.75rem !important;
            }
            
            footer {
                padding: 1rem 0 !important;
                margin-top: 2rem !important;
            }
            
            label {
                font-weight: 600 !important;
                color: #4b5563 !important;
                margin-bottom: 0.5rem !important;
            }
            
            input[type="time"] {
                padding: 0.75rem !important;
                font-size: 1rem !important;
                border-radius: 0.5rem !important;
                border: 2px solid #d1d5db !important;
            }
            
            input[type="checkbox"] {
                width: 1.25rem !important;
                height: 1.25rem !important;
                margin-right: 0.5rem !important;
            }
            
            .option-list {
                margin-left: 1rem !important;
                margin-top: 0.75rem !important;
            }
            
            .option-list li {
                margin-bottom: 1rem !important;
                padding-left: 0.25rem !important;
                line-height: 1.5 !important;
            }
            
            .option-list li::before {
                left: -1.25rem !important;
            }
            
            .violation-point, .warning-point, .risk-point {
                padding: 1rem !important;
                margin: 0.75rem 0 !important;
                border-radius: 0.5rem !important;
            }
            
            .message-content {
                font-size: 0.95rem !important;
                padding-right: 0.5rem !important;
            }
            
            .result-card h3 {
                font-size: 1.25rem !important;
                margin-bottom: 1rem !important;
            }
            
            .result-card .text-base {
                font-size: 0.9rem !important;
            }
            
            /* Fix for text overflow in result cards */
            .result-card .flex {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .result-card .flex-1 {
                width: 100% !important;
                margin-left: 0 !important;
                padding-left: 0 !important;
            }
            
            .result-card .result-icon {
                margin-bottom: 0.75rem !important;
                margin-right: 0 !important;
            }
        }
        
        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .day-header {
                font-size: 1rem !important;
            }
            
            h1 {
                font-size: 1.25rem !important;
            }
            
            p {
                font-size: 0.8rem !important;
            }
            
            .gradient-button {
                font-size: 1rem !important;
                padding: 0.875rem 1.5rem !important;
            }
            
            input[type="time"] {
                font-size: 0.875rem !important;
            }
            
            label {
                font-size: 0.8rem !important;
            }
            
            .message-content {
                font-size: 0.85rem !important;
            }
            
            .option-list li {
                font-size: 0.85rem !important;
            }
        }
    </style>
</head>
<body class="flex flex-col">
    <div class="container mx-auto px-2 py-4 md:py-6 md:px-4 max-w-6xl flex-1">
        <!-- Header -->
        <header class="text-center mb-4 md:mb-6">
            <div class="header-bg">
                <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-3">Night and Disruptive Duties</h1>
                <p class="text-sm md:text-base opacity-90 max-w-3xl mx-auto">
                    Strumento per verificare se la regolamentazione prevista dal manuale nei paragrafi OMA 7.4.7 (1,2) Night Duties e 7.4.10.1 Consecutive Easyjet Disruptive Duties è stata correttamente applicata.
                </p>
                <div class="mt-3">
                    <i class="fas fa-plane-departure text-xl md:text-2xl opacity-70"></i>
                </div>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-container p-3 md:p-4 lg:p-6">
            <!-- Days Grid - Now vertical layout -->
            <div class="space-y-3 md:space-y-4 mb-4 md:mb-6">
                <!-- Day 1 -->
                <div class="day-section day-1 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="1">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 1</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-1">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-1" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-1" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-1">
                        </div>
                    </div>
                </div>
                <!-- Day 2 -->
                <div class="day-section day-2 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="2">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 2</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-2">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-2" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-2" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-2">
                        </div>
                    </div>
                </div>
                <!-- Day 3 -->
                <div class="day-section day-3 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="3">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 3</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-3">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-3" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-3" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-3">
                        </div>
                    </div>
                </div>
                <!-- Day 4 -->
                <div class="day-section day-4 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="4">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 4</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-4">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-4" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-4" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-4">
                        </div>
                    </div>
                </div>
                <!-- Day 5 -->
                <div class="day-section day-5 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="5">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 5</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-5">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-5" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-5" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-5">
                        </div>
                    </div>
                </div>
                <!-- Day 6 -->
                <div class="day-section day-6 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="6">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 6</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-6">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-6" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-6" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-6">
                        </div>
                    </div>
                </div>
                <!-- Day 7 -->
                <div class="day-section day-7 bg-gray-50 rounded-lg p-3 md:p-4 flex items-center" data-day="7">
                    <div class="w-16 md:w-24 day-header text-base md:text-lg">Giorno 7</div>
                    <div class="flex-1 flex flex-col md:flex-row gap-2 md:gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Previsto</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="scheduled-7">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="dayoff-7" class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                            <label for="dayoff-7" class="ml-2 text-sm font-medium text-gray-700">DAY OFF</label>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Orario Ritardato (opzionale)</label>
                            <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="delayed-7">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Verify Button -->
            <div class="verify-section text-center">
                <button onclick="verifyCompliance()" class="gradient-button text-white font-semibold py-3 px-8 rounded-lg text-lg inline-flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    VERIFICA
                </button>
            </div>
            <!-- Results Area -->
            <div id="results" class="hidden">
                <!-- Results will be dynamically inserted here -->
            </div>
            <!-- Risk Results Area -->
            <div id="risk-results" class="hidden mt-6">
                <h2 class="text-xl font-bold text-orange-800 mb-4">Turni a Rischio</h2>
                <!-- Risk results will be dynamically inserted here -->
            </div>
        </main>
    </div>
    <!-- Footer with Disclaimer -->
    <footer class="bg-gray-800 text-gray-300 py-3 md:py-4 mt-6 md:mt-8">
        <div class="container mx-auto px-2 md:px-4 text-center">
            <p class="text-xs md:text-sm">
                © 2025 verifica-night-disruptive-duties.netlify.app – Tutti i diritti riservati. Il design, il codice e i contenuti di questa web app sono protetti da copyright. È vietata la riproduzione o diffusione non autorizzata, anche parziale, senza esplicita autorizzazione.
            </p>
        </div>
    </footer>
    <script>
        // Add event listeners for DAY OFF checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const day = this.id.split('-')[1];
                const scheduledInput = document.getElementById(`scheduled-${day}`);
                const delayedInput = document.getElementById(`delayed-${day}`);
                
                if (this.checked) {
                    scheduledInput.disabled = true;
                    delayedInput.disabled = true;
                    scheduledInput.value = '';
                    delayedInput.value = '';
                } else {
                    scheduledInput.disabled = false;
                    delayedInput.disabled = false;
                }
            });
        });
        
        function verifyCompliance() {
            // Remove any previous risk highlights
            document.querySelectorAll('.day-section').forEach(day => {
                day.classList.remove('risk-highlight');
            });
            
            const results = [];
            const riskResults = [];
            const days = [];
            
            // Collect all day data
            for (let i = 1; i <= 7; i++) {
                const isDayOff = document.getElementById(`dayoff-${i}`).checked;
                const scheduled = document.getElementById(`scheduled-${i}`).value;
                const delayed = document.getElementById(`delayed-${i}`).value;
                
                days.push({
                    day: i,
                    isDayOff,
                    scheduled,
                    delayed,
                    actualEndTime: delayed || scheduled
                });
            }
            
            // Check Night Duties (2 and 3 consecutive)
            checkNightDuties(days, results);
            
            // Check Disruptive Duties (consecutive and total in 7 days)
            checkDisruptiveDuties(days, results);
            
            // Check for risk cases
            checkRiskCases(days, riskResults);
            
            // Display results
            displayResults(results);
            
            // Display risk results if any
            if (riskResults.length > 0) {
                displayRiskResults(riskResults);
                
                // Highlight risk days
                riskResults.forEach(risk => {
                    if (risk.riskDay) {
                        const dayElement = document.querySelector(`.day-section[data-day="${risk.riskDay}"]`);
                        if (dayElement) {
                            dayElement.classList.add('risk-highlight');
                        }
                    }
                });
            } else {
                document.getElementById('risk-results').classList.add('hidden');
            }
        }
        
        function checkNightDuties(days, results) {
            // Find sequences of consecutive night duties
            for (let i = 0; i < days.length; i++) {
                if (days[i].isDayOff || !days[i].scheduled) continue;
                
                // Check if this is a night duty (based on scheduled time)
                if (!isNightDuty(days[i].scheduled)) continue;
                
                // Find consecutive night duties starting from this day
                const sequence = [days[i]];
                let j = i + 1;
                
                while (j < days.length && !days[j].isDayOff && days[j].scheduled && isNightDuty(days[j].scheduled)) {
                    sequence.push(days[j]);
                    j++;
                }
                
                // Check sequence length
                if (sequence.length >= 2) {
                    // Get the day before the sequence
                    const prevDayIndex = i - 1;
                    
                    if (prevDayIndex >= 0 && !days[prevDayIndex].isDayOff && days[prevDayIndex].scheduled) {
                        const prevDayScheduled = days[prevDayIndex].scheduled;
                        const prevDayActual = days[prevDayIndex].actualEndTime;
                        
                        if (sequence.length === 2) {
                            // Rule for 2 consecutive night duties
                            const prevScheduledMinutes = timeToMinutes(prevDayScheduled);
                            const prevActualMinutes = timeToMinutes(prevDayActual);
                            
                            // Check if previous day scheduled end is within 23:59
                            if (prevScheduledMinutes <= 1439) { // 23:59
                                // But actual end is after 23:59 OR after midnight
                                if (prevActualMinutes > 1439 || prevActualMinutes < 720) { // After 23:59 or after midnight
                                    results.push({
                                        type: 'illegal',
                                        message: `VIOLAZIONE: 2 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) con il giorno precedente (Giorno ${days[prevDayIndex].day}) che termina con orario ritardato oltre le 23:59. DOVREBBE TERMINARE ENTRO LE 23:59. SOLO IL PRIMO DEI DUE NIGHT DUTIES SUCCESSIVI PUO' ESSERE EFFETTUATO.`,
                                        regulation: 'Night Duties - 2 Consecutivi'
                                    });
                                }
                            } else {
                                // Previous day scheduled end is after 23:59
                                results.push({
                                    type: 'illegal',
                                    message: `VIOLAZIONE: 2 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) con il giorno precedente (Giorno ${days[prevDayIndex].day}) che termina con orario previsto oltre le 23:59. DOVREBBE TERMINARE ENTRO LE 23:59.`,
                                    regulation: 'Night Duties - 2 Consecutivi'
                                });
                            }
                        } else if (sequence.length >= 3) {
                            // Rule for 3 consecutive night duties
                            const prevScheduledMinutes = timeToMinutes(prevDayScheduled);
                            const prevActualMinutes = timeToMinutes(prevDayActual);
                            
                            // Check if previous day scheduled end is within 21:00
                            if (prevScheduledMinutes <= 1260) { // 21:00
                                // But actual end is after 21:00
                                if (prevActualMinutes > 1260 || prevActualMinutes < 720) { // After 21:00 or after midnight
                                    if (prevActualMinutes <= 1439 && prevActualMinutes >= 1260) { // Between 21:00 and 23:59
                                        results.push({
                                            type: 'warning',
                                            message: `ATTENZIONE: 3 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) con il giorno precedente (Giorno ${days[prevDayIndex].day}) che termina con orario ritardato tra le 21:00 e le 23:59. DOVREBBE TERMINARE ENTRO LE 21:00. L'ASSISTENTE DI VOLO DOVRA' DECIDERE: 1) Se non proseguire, potrà effettuare SOLO il primo ed il secondo dei night duties programmati. 2) La programmazione dei 3 giorni successivi può continuare.`,
                                            regulation: 'Night Duties - 3 Consecutivi'
                                        });
                                    } else { // After 23:59 or after midnight
                                        results.push({
                                            type: 'illegal',
                                            message: `VIOLAZIONE: 3 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) con il giorno precedente (Giorno ${days[prevDayIndex].day}) che termina con orario ritardato oltre le 23:59. DOVREBBE TERMINARE ENTRO LE 21:00. L'assistente di volo DOVRA' completare solo il primo dei tre night duties previsti.`,
                                            regulation: 'Night Duties - 3 Consecutivi'
                                        });
                                    }
                                }
                            } else {
                                // Previous day scheduled end is after 21:00
                                results.push({
                                    type: 'illegal',
                                    message: `VIOLAZIONE: 3 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) con il giorno precedente (Giorno ${days[prevDayIndex].day}) che termina con orario previsto oltre le 21:00. DOVREBBE TERMINARE ENTRO LE 21:00.`,
                                    regulation: 'Night Duties - 3 Consecutivi'
                                });
                            }
                        }
                    }
                    
                    // Skip the sequence we just processed
                    i = j - 1;
                }
            }
        }
        
        function checkDisruptiveDuties(days, results) {
            // Check consecutive disruptive duties
            let consecutiveCount = 0;
            let consecutiveDays = [];
            let hasConsecutiveViolation = false;
            
            days.forEach(day => {
                if (!day.isDayOff && day.actualEndTime && isDisruptiveDuty(day.actualEndTime)) {
                    consecutiveCount++;
                    consecutiveDays.push(day.day);
                    
                    if (consecutiveCount > 3) {
                        hasConsecutiveViolation = true;
                        results.push({
                            type: 'illegal',
                            message: `VIOLAZIONE: Più di 3 disruptive duties consecutivi. Sequenza: Giorno ${consecutiveDays.join(', Giorno ')}. DOVREBBERO ESSERE MASSIMO 3 CONSECUTIVI.`,
                            regulation: 'Disruptive Duties - Consecutivi'
                        });
                    }
                } else {
                    consecutiveCount = 0;
                    consecutiveDays = [];
                }
            });
            
            // Check total disruptive duties in 7 days
            const totalDisruptiveDays = [];
            days.forEach(day => {
                if (!day.isDayOff && day.actualEndTime && isDisruptiveDuty(day.actualEndTime)) {
                    totalDisruptiveDays.push(day.day);
                }
            });
            
            if (totalDisruptiveDays.length > 4) {
                results.push({
                    type: 'illegal',
                    message: `VIOLAZIONE: Oltre 4 disruptive duties in 7 giorni. Totale: ${totalDisruptiveDays.length} (limite: 4). Giorni con disruptive duties: Giorno ${totalDisruptiveDays.join(', Giorno ')}. DOVREBBERO ESSERE MASSIMO 4 IN 7 GIORNI.`,
                    regulation: 'Disruptive Duties - Totale 7 giorni'
                });
            } else if (totalDisruptiveDays.length === 4 && !hasConsecutiveViolation) {
                // Check if the 4 disruptive duties are all consecutive
                const sortedDays = [...totalDisruptiveDays].sort((a, b) => a - b);
                let allConsecutive = true;
                
                for (let i = 1; i < sortedDays.length; i++) {
                    if (sortedDays[i] !== sortedDays[i-1] + 1) {
                        allConsecutive = false;
                        break;
                    }
                }
                
                if (allConsecutive) {
                    results.push({
                        type: 'illegal',
                        message: `VIOLAZIONE: 4 disruptive duties in 7 giorni sono tutti consecutivi (Giorni ${totalDisruptiveDays.join(', Giorno ')}). SE SONO 4 NON DEVONO ESSERE CONSECUTIVI.`,
                        regulation: 'Disruptive Duties - 4 Consecutivi'
                    });
                }
            }
        }
        
        function checkRiskCases(days, riskResults) {
            // Check for 2 consecutive night duties risk
            for (let i = 0; i < days.length; i++) {
                if (days[i].isDayOff || !days[i].scheduled) continue;
                
                // Check if this is a night duty
                if (!isNightDuty(days[i].scheduled)) continue;
                
                // Find consecutive night duties starting from this day
                const sequence = [days[i]];
                let j = i + 1;
                
                while (j < days.length && !days[j].isDayOff && days[j].scheduled && isNightDuty(days[j].scheduled)) {
                    sequence.push(days[j]);
                    j++;
                }
                
                // Check for 2 consecutive night duties
                if (sequence.length === 2) {
                    // Get the day before the sequence
                    const prevDayIndex = i - 1;
                    if (prevDayIndex >= 0 && !days[prevDayIndex].isDayOff && days[prevDayIndex].scheduled) {
                        // Use delayed time if available, otherwise use scheduled time
                        const prevDayTime = days[prevDayIndex].delayed || days[prevDayIndex].scheduled;
                        const prevDayMinutes = timeToMinutes(prevDayTime);
                        
                        // Check if previous day end time is between 23:29 and 23:59
                        if (prevDayMinutes >= 1409 && prevDayMinutes <= 1439) { // 23:29 to 23:59
                            riskResults.push({
                                type: 'risk',
                                message: `ATTENZIONE: Il giorno precedente (Giorno ${days[prevDayIndex].day}) ai 2 night duties consecutivi (Giorni ${sequence.map(d => d.day).join(', ')}) è a rischio. Un eventuale ritardo oltre le 23:59 comporterebbe la violazione della regolamentazione, costringendo a svolgere solo il primo dei due night duties.`,
                                riskDay: days[prevDayIndex].day
                            });
                        }
                    }
                }
                // Check for 3 consecutive night duties
                else if (sequence.length >= 3) {
                    // Get the day before the sequence
                    const prevDayIndex = i - 1;
                    if (prevDayIndex >= 0 && !days[prevDayIndex].isDayOff && days[prevDayIndex].scheduled) {
                        // Use delayed time if available, otherwise use scheduled time
                        const prevDayTime = days[prevDayIndex].delayed || days[prevDayIndex].scheduled;
                        const prevDayMinutes = timeToMinutes(prevDayTime);
                        
                        // Check if previous day end time is between 20:30 and 21:00
                        if (prevDayMinutes >= 1230 && prevDayMinutes <= 1260) { // 20:30 to 21:00
                            riskResults.push({
                                type: 'risk',
                                message: `ATTENZIONE: Il giorno precedente (Giorno ${days[prevDayIndex].day}) ai 3 night duties consecutivi (Giorni ${sequence.slice(0,3).map(d => d.day).join(', ')}) è a rischio. Un eventuale ritardo oltre le 21:00 comporterebbe la necessità di decidere se proseguire o meno con la programmazione. In caso di ritardo oltre le 23:59, si potrebbe svolgere solo il primo dei tre night duties.`,
                                riskDay: days[prevDayIndex].day
                            });
                        }
                    }
                }
                
                // Skip the sequence we just processed
                i = j - 1;
            }
            
            // Check for disruptive duties risks
            // 1. 3 consecutive disruptive duties (risk of becoming 4)
            let consecutiveCount = 0;
            let consecutiveDays = [];
            for (let i = 0; i < days.length; i++) {
                if (!days[i].isDayOff && days[i].actualEndTime && isDisruptiveDuty(days[i].actualEndTime)) {
                    consecutiveCount++;
                    consecutiveDays.push(days[i].day);
                    
                    if (consecutiveCount === 3) {
                        riskResults.push({
                            type: 'risk',
                            message: `ATTENZIONE: Sono presenti 3 disruptive duties consecutive (Giorni ${consecutiveDays.join(', ')}). Questo è a rischio perché non è consentito avere più di 3 disruptive duties consecutivi. Un ulteriore disruptive duty consecutivo violerebbe la regolamentazione.`
                        });
                    }
                } else {
                    consecutiveCount = 0;
                    consecutiveDays = [];
                }
            }
            
            // 2. 4 disruptive duties in 7 days (or less) - non consecutive
            const totalDisruptiveDays = [];
            days.forEach(day => {
                if (!day.isDayOff && day.actualEndTime && isDisruptiveDuty(day.actualEndTime)) {
                    totalDisruptiveDays.push(day.day);
                }
            });
            
            if (totalDisruptiveDays.length === 4) {
                riskResults.push({
                    type: 'risk',
                    message: `ATTENZIONE: Sono già presenti 4 disruptive duties in ${days.length} giorni (Giorni ${totalDisruptiveDays.join(', ')}). Questo è a rischio perché non è consentito avere più di 4 disruptive duties in 7 giorni. Ulteriori disruptive duties violerebbero la regolamentazione.`
                });
            }
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return null;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function isNightDuty(timeStr) {
            const minutes = timeToMinutes(timeStr);
            if (!minutes) return false;
            return minutes >= 120 && minutes <= 299; // 02:00 to 04:59
        }
        
        function isDisruptiveDuty(timeStr) {
            const minutes = timeToMinutes(timeStr);
            if (!minutes) return false;
            return minutes >= 60 && minutes <= 405; // 01:00 to 06:45
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('hidden');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="result-enter bg-green-100 border-2 border-green-400 rounded-lg p-6">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 text-3xl mr-3"></i>
                            <div>
                                <h3 class="text-xl font-semibold text-green-800">Il turno è legale</h3>
                                <p class="mt-2 text-green-700">Tutte le normative Easyjet sono state rispettate.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    let bgColor, borderColor, textColor, icon;
                    
                    if (result.type === 'illegal') {
                        bgColor = 'bg-red-100';
                        borderColor = 'border-red-400';
                        textColor = 'text-red-800';
                        icon = '<i class="fas fa-exclamation-circle text-red-600 result-icon"></i>';
                    } else if (result.type === 'warning') {
                        bgColor = 'bg-yellow-100';
                        borderColor = 'border-yellow-400';
                        textColor = 'text-yellow-800';
                        icon = '<i class="fas fa-exclamation-triangle text-yellow-600 result-icon"></i>';
                    }
                    
                    // Format the message for better readability
                    let formattedMessage = result.message;
                    if (result.regulation === 'Night Duties - 3 Consecutivi' && result.type === 'warning') {
                        // Extract the information from the message
                        const match = result.message.match(/ATTENZIONE: 3 night duties consecutivi \(Giorni (.+?)\) con il giorno precedente \(Giorno (.+?)\) che termina con orario ritardato tra le 21:00 e le 23:59\. DOVREBBE TERMINARE ENTRO LE 21:00\. L'ASSISTENTE DI VOLO DOVRA' DECIDERE: 1\) Se non proseguire, potrà effettuare SOLO il primo ed il secondo dei night duties programmati\. 2\) La programmazione dei 3 giorni successivi può continuare\./);
                        
                        if (match) {
                            const sequenceDays = match[1];
                            const prevDay = match[2];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>3 night duties consecutivi</strong> (Giorni ${sequenceDays}) con il giorno precedente (Giorno ${prevDay}) che termina con orario ritardato tra le 21:00 e le 23:59.</p>
                                    
                                    <div class="warning-point mt-4">
                                        <p class="font-semibold"><strong>DOVREBBE TERMINARE ENTRO LE 21:00.</strong></p>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <p class="font-semibold"><strong>L'ASSISTENTE DI VOLO DOVRA' DECIDERE:</strong></p>
                                        <p class="text-sm italic mt-1">(comunicando al comandante la propria volontà)</p>
                                        <ul class="option-list mt-3">
                                            <li><strong>Se non proseguire con la programmazione</strong>: potrà effettuare <strong>SOLO il primo ed il secondo</strong> dei night duties programmati</li>
                                            <li><strong>Se continuare</strong>: la programmazione dei 3 giorni successivi <strong>può continuare</strong></li>
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (result.message.includes('2 night duties consecutivi')) {
                        // Format for 2 consecutive night duties
                        const match = result.message.match(/VIOLAZIONE: 2 night duties consecutivi \(Giorni (.+?)\) con il giorno precedente \(Giorno (.+?)\) che termina con orario (.+?) oltre le 23:59\. (.+)\./);
                        
                        if (match) {
                            const sequenceDays = match[1];
                            const prevDay = match[2];
                            const scheduleType = match[3];
                            const consequence = match[4];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>2 night duties consecutivi</strong> (Giorni ${sequenceDays}) con il giorno precedente (Giorno ${prevDay}) che termina con orario ${scheduleType} oltre le 23:59.</p>
                                    
                                    <div class="violation-point mt-4">
                                        <p class="font-semibold"><strong>DOVREBBE TERMINARE ENTRO LE 23:59.</strong></p>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-red-50 rounded-md">
                                        <p class="font-semibold text-red-700"><strong>CONSEGUENZA:</strong></p>
                                        <p class="mt-2">${consequence}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (result.message.includes('3 night duties consecutivi') && result.type === 'illegal') {
                        // Format for 3 consecutive night duties - illegal
                        const match = result.message.match(/VIOLAZIONE: 3 night duties consecutivi \(Giorni (.+?)\) con il giorno precedente \(Giorno (.+?)\) che termina con orario (.+?) oltre le (.+?)\. (.+)\./);
                        
                        if (match) {
                            const sequenceDays = match[1];
                            const prevDay = match[2];
                            const scheduleType = match[3];
                            const timeLimit = match[4];
                            const consequence = match[5];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>3 night duties consecutivi</strong> (Giorni ${sequenceDays}) con il giorno precedente (Giorno ${prevDay}) che termina con orario ${scheduleType} oltre le ${timeLimit}.</p>
                                    
                                    <div class="violation-point mt-4">
                                        <p class="font-semibold"><strong>DOVREBBE TERMINARE ENTRO LE 21:00.</strong></p>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-red-50 rounded-md">
                                        <p class="font-semibold text-red-700"><strong>CONSEGUENZA:</strong></p>
                                        <p class="mt-2">${consequence}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (result.message.includes('disruptive duties consecutivi')) {
                        // Format for disruptive duties consecutive
                        const match = result.message.match(/VIOLAZIONE: Più di 3 disruptive duties consecutivi\. Sequenza: Giorno (.+?)\. (.+)\./);
                        
                        if (match) {
                            const sequenceDays = match[1];
                            const rule = match[2];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>Violazione limite disruptive duties consecutivi</strong></p>
                                    
                                    <div class="violation-point mt-4">
                                        <p><strong>Sequenza identificata:</strong> Giorno ${sequenceDays}</p>
                                        <p class="mt-2"><strong>Limite superato:</strong> Più di 3 consecutivi</p>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-red-50 rounded-md">
                                        <p class="font-semibold text-red-700"><strong>REGOLA:</strong></p>
                                        <p class="mt-2">${rule}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (result.message.includes('disruptive duties in 7 giorni')) {
                        // Format for disruptive duties total in 7 days
                        const match = result.message.match(/VIOLAZIONE: (.+?) Totale: (.+?) \(limite: (.+?)\. Giorni con disruptive duties: Giorno (.+?)\. (.+)\./);
                        
                        if (match) {
                            const violationType = match[1];
                            const total = match[2];
                            const limit = match[3];
                            const days = match[4];
                            const rule = match[5];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>${violationType}</strong></p>
                                    
                                    <div class="violation-point mt-4">
                                        <p><strong>Totale disruptive duties:</strong> ${total}</p>
                                        <p class="mt-2"><strong>Limite consentito:</strong> ${limit}</p>
                                        <p class="mt-2"><strong>Giorni coinvolti:</strong> Giorno ${days}</p>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-red-50 rounded-md">
                                        <p class="font-semibold text-red-700"><strong>REGOLA:</strong></p>
                                        <p class="mt-2">${rule}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (result.message.includes('4 disruptive duties in 7 giorni sono tutti consecutivi')) {
                        // Format for 4 consecutive disruptive duties
                        const match = result.message.match(/VIOLAZIONE: 4 disruptive duties in 7 giorni sono tutti consecutivi \(Giorni (.+?)\)\. (.+)\./);
                        
                        if (match) {
                            const days = match[1];
                            const rule = match[2];
                            
                            formattedMessage = `
                                <div class="message-content">
                                    <p class="mb-3"><strong>4 disruptive duties consecutivi non consentiti</strong></p>
                                    
                                    <div class="violation-point mt-4">
                                        <p><strong>Giorni coinvolti:</strong> Giorno ${days}</p>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-red-50 rounded-md">
                                        <p class="font-semibold text-red-700"><strong>REGOLA SPECIALE:</strong></p>
                                        <p class="mt-2">${rule}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    const resultHtml = `
                        <div class="result-enter ${bgColor} ${borderColor} result-card p-6 mb-4">
                            <div class="flex items-start">
                                ${icon}
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold ${textColor} mb-4">${result.type === 'illegal' ? 'VIOLAZIONE' : 'ATTENZIONE'}</h3>
                                    <div class="text-base ${textColor.replace('800', '700')}">${formattedMessage}</div>
                                    <div class="mt-4 pt-3 border-t border-gray-200">
                                        <p class="text-sm ${textColor.replace('800', '600')} font-medium">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Regolazione: ${result.regulation}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    resultsDiv.innerHTML += resultHtml;
                });
            }
        }
        
        function displayRiskResults(riskResults) {
            const riskResultsDiv = document.getElementById('risk-results');
            riskResultsDiv.innerHTML = '<h2 class="text-xl font-bold text-orange-800 mb-4">Turni a Rischio</h2>';
            riskResultsDiv.classList.remove('hidden');
            
            riskResults.forEach(risk => {
                const resultHtml = `
                    <div class="result-enter bg-orange-100 border-2 border-orange-400 result-card p-6 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-orange-600 result-icon"></i>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-orange-800 mb-4">ATTENZIONE</h3>
                                <div class="text-base text-orange-700">
                                    <div class="risk-point">
                                        ${risk.message}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                riskResultsDiv.innerHTML += resultHtml;
            });
        }
    </script>
</body>
</html>
